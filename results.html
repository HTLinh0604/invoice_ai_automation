<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K·∫øt qu·∫£ tr√≠ch xu·∫•t h√≥a ƒë∆°n</title>
  <link rel="stylesheet"
        href="{{ url_for('static', path='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link rel="icon" type="image/png" href="https://emojiapi.dev/api/v1/page_facing_up/64.png">    
  <style>
    body {
      background-color: #f8f9fa;
    }

    .editable[contenteditable="true"] {
      outline: 2px dashed #0d6efd;
      background: #fffefa;
      transition: background 0.3s ease, outline 0.3s ease;
    }

    .invoice-block {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    .invoice-block:hover {
      transform: scale(1.005);
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
    }

    .invoice-image {
      max-width: 180px;
      height: auto;
      border-radius: 4px;
      transition: transform 0.3s ease;
    }

    .invoice-image:hover {
      transform: scale(1.05);
    }

    .btn {
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .btn:hover {
      transform: scale(1.03);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .edit-btn:focus,
    .save-edit-btn:focus,
    .json-btn:focus {
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center">üìÑ K·∫øt qu·∫£ tr√≠ch xu·∫•t h√≥a ƒë∆°n</h2>

    {% for invoice in results %}
    <div class="invoice-block mb-4 p-3" data-idx="{{ loop.index0 }}"
         style="border-left:5px solid #0d6efd">

      <h6>üßæ {{ invoice.filename }}</h6>
      <img src="{{ url_for('static', path='uploads/' + invoice.filename) }}"
           class="invoice-image" alt="·∫¢nh h√≥a ƒë∆°n">

      <!-- Th√¥ng tin ch√≠nh -->
      <p><strong>C·ª≠a h√†ng:</strong>
        <span class="editable" data-field="store_name" contenteditable="false">
          {{ invoice.json.get("store_name","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>ƒê·ªãa ch·ªâ:</strong>
        <span class="editable" data-field="address" contenteditable="false">
          {{ invoice.json.get("address","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>Ng√†y gi·ªù:</strong>
        <span class="editable" data-field="receipt_datetime" contenteditable="false">
          {{ invoice.json.get("receipt_datetime","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>Nh√¢n vi√™n:</strong>
        <span class="editable" data-field="staff_name" contenteditable="false">
          {{ invoice.json.get("staff_name","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong>
        <span class="editable" data-field="payment_method" contenteditable="false">
          {{ invoice.json.get("payment_method","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>M√£ h√≥a ƒë∆°n:</strong>
        <span class="editable" data-field="receipt_number" contenteditable="false">
          {{ invoice.json.get("receipt_number","Kh√¥ng r√µ") }}
        </span>
      </p>

      <!-- S·∫£n ph·∫©m -->
      <h5 class="mt-3">üõí S·∫£n ph·∫©m</h5>
      <table class="table table-bordered items-table">
        <thead class="table-light">
          <tr>
            <th>T√™n</th><th>S·ªë l∆∞·ª£ng</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th>
          </tr>
        </thead>
        <tbody>
          {% for item in invoice.json.get("items", []) %}
          <tr data-item-idx="{{ loop.index0 }}">
            <td class="editable" data-field="name"        contenteditable="false">{{ item.name }}</td>
            <td class="editable" data-field="quantity"    contenteditable="false">{{ item.quantity or "" }}</td>
            <td class="editable" data-field="unit_price"  contenteditable="false">{{ item.unit_price or "" }}</td>
            <td class="editable" data-field="total_price" contenteditable="false">{{ item.total_price or "" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <p><strong>T·ªïng c·ªông:</strong>
        <span class="editable" data-field="total_amount" contenteditable="false">
          {{ invoice.json.get("total_amount","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>Gi·∫£m gi√°:</strong>
        <span class="editable" data-field="discount_amount" contenteditable="false">
          {{ invoice.json.get("discount_amount","0") }}
        </span>
      </p>
      <p><strong>S·ªë ti·ªÅn thanh to√°n:</strong>
        <span class="editable" data-field="paid_amount" contenteditable="false">
          {{ invoice.json.get("paid_amount","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>Kh√°ch ƒë∆∞a:</strong>
        <span class="editable" data-field="customer_paid" contenteditable="false">
          {{ invoice.json.get("customer_paid","Kh√¥ng r√µ") }}
        </span>
      </p>
      <p><strong>Ti·ªÅn th·ª´a:</strong>
        <span class="editable" data-field="change" contenteditable="false">
          {{ invoice.json.get("change","Kh√¥ng r√µ") }}
        </span>
      </p>

      <!-- *** BA N√öT ƒêI·ªÄU KHI·ªÇN *** -->
      <div class="d-flex gap-2 mt-2">
        <button type="button" class="btn btn-outline-secondary edit-btn">
          üñäÔ∏è Ch·ªânh s·ª≠a th√¥ng tin
        </button>
        <a href="#" class="btn btn-outline-primary json-btn">
          ‚¨áÔ∏è T·∫£i d·ªØ li·ªáu JSON
        </a>
        <button type="button" class="btn btn-outline-success save-edit-btn" disabled>
          üì• L∆∞u ch·ªânh s·ª≠a
        </button>
      </div>
    </div>
    {% endfor %}

    <div class="d-flex justify-content-between mt-4">
      <a href="/" class="btn btn-secondary">‚¨ÜÔ∏è T·∫£i ·∫£nh kh√°c</a>
      <button id="save-btn" class="btn btn-success">üíæ L∆∞u v√†o C∆° s·ªü d·ªØ li·ªáu</button>
      <a href="/chat" target="_blank" class="btn btn-primary">ü§ñ Tr·ª£ l√Ω</a>
    </div>
  </div>

  <!-- embed d·ªØ li·ªáu -->
  <script id="invoices-json" type="application/json">
    {{ results | tojson | safe }}
  </script>

  <script>
    const invoicesData = JSON.parse(
      document.getElementById("invoices-json").textContent
    );

    document.querySelectorAll(".invoice-block").forEach(block => {
      const idx     = +block.dataset.idx;
      const editBtn = block.querySelector(".edit-btn");
      const saveBtn = block.querySelector(".save-edit-btn");
      const jsonBtn = block.querySelector(".json-btn");

      // b·∫≠t mode edit
      editBtn.addEventListener("click", () => {
        block.querySelectorAll(".editable").forEach(el => {
          el.contentEditable = true;
        });
        saveBtn.disabled = false;
      });

      // l∆∞u ch·ªânh s·ª≠a v√†o invoicesData v√† t·∫Øt edit
      saveBtn.addEventListener("click", () => {
        block.querySelectorAll(".editable").forEach(el => {
          el.contentEditable = false;
          const key = el.dataset.field;
          const row = el.closest("tr");
          if (row) {
            const itemIdx = +row.dataset.itemIdx;
            invoicesData[idx].json.items[itemIdx][key] = el.innerText.trim();
          } else {
            invoicesData[idx].json[key] = el.innerText.trim();
          }
        });
        saveBtn.disabled = true;
        alert("ƒê√£ l∆∞u ch·ªânh s·ª≠a cho h√≥a ƒë∆°n n√†y.");
      });

      // t·∫£i JSON ƒë√£ ch·ªânh s·ª≠a
      jsonBtn.addEventListener("click", e => {
        e.preventDefault();
        const data = invoicesData[idx].json;
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a   = document.createElement("a");
        a.href    = url;
        a.download= invoicesData[idx].filename.replace(/\.(jpe?g|png)$/, "") + ".json";
        document.body.append(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    });

    // N√∫t l∆∞u v√†o Milvus
    document.getElementById("save-btn").onclick = async () => {
      try {
        const resp = await fetch("/save_milvus", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(invoicesData)
        });
        const data = await resp.json();
        alert(data.message);
      } catch (e) {
        alert("L·ªói khi l∆∞u v√†o Milvus: " + e);
      }
    };
  </script>
</body>
</html>